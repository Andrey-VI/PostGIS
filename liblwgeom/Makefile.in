# **********************************************************************
# * $Id: Makefile.in 
# *
# * PostGIS - Spatial Types for PostgreSQL
# * http://postgis.refractions.net
# * Copyright 2008 Mark Cave-Ayland
# *
# * This is free software; you can redistribute and/or modify it under
# * the terms of the GNU General Public Licence. See the COPYING file.
# *
# **********************************************************************

CC = @CC@
CFLAGS = @CFLAGS@ @PICFLAGS@ @WARNFLAGS@ @GEOS_CPPFLAGS@ -DPOSTGIS_GEOS_VERSION=@POSTGIS_GEOS_VERSION@
LDFLAGS = @GEOS_LDFLAGS@ -lgeos_c
NUMERICFLAGS = @NUMERICFLAGS@
top_builddir = @top_builddir@
prefix = @prefix@
exec_prefix = @exec_prefix@
libdir = @libdir@
INSTALL = $(SHELL) ../install-sh

SONAME = liblwgeom.so.@POSTGIS_MAJOR_VERSION@
SOVER = @POSTGIS_MAJOR_VERSION@.@POSTGIS_MINOR_VERSION@.@POSTGIS_MICRO_VERSION@


YACC=@YACC@
LEX=@LEX@

# Standalone LWGEOM objects
SA_OBJS = \
	stringbuffer.o \
	measures.o \
	measures3d.o \
	box2d.o \
	ptarray.o \
	lwgeom_api.o \
	lwgeom.o \
	lwpoint.o \
	lwline.o \
	lwpoly.o \
	lwtriangle.o \
	lwmpoint.o \
	lwmline.o \
	lwmpoly.o \
	lwcollection.o \
	lwcircstring.o \
	lwcompound.o \
	lwcurvepoly.o \
	lwmcurve.o \
	lwmsurface.o \
	lwpsurface.o \
	lwtin.o \
	lwout_wkb.o \
	lwin_wkb.o \
	lwout_wkt.o \
	lwin_wkt_parse.o \
	lwin_wkt_lex.o \
	lwin_wkt.o \
	lwutil.o \
	lwhomogenize.o \
	lwalgorithm.o \
	lwgunparse.o \
	lwgparse.o \
	lwsegmentize.o \
	lwprint.o \
	wktparse.tab.o \
	lex.yy.o \
	vsprintf.o \
	g_box.o \
	g_serialized.o \
	g_util.o \
	lwgeodetic.o \
	lwtree.o \
	libtgeom.o \
	lwout_gml.o \
	lwout_kml.o \
	lwout_geojson.o \
	lwout_svg.o \
	lwout_x3d.o \
	lwgeom_geos.o \
	lwgeom_geos_clean.o

NM_OBJS = \
	lwspheroid.o 

OBJS = $(SA_OBJS) $(NM_OBJS)

SA_HEADERS = \
	liblwgeom.h \
	liblwgeom_internal.h \
	libtgeom.h \
	lwgeom_geos.h

all: liblwgeom.a

# nothing to install or uninstall
install uninstall:

install-liblwgeom: liblwgeom.so liblwgeom.a
	$(INSTALL) liblwgeom.so $(DESTDIR)$(libdir)/liblwgeom.so.$(SOVER)
	$(INSTALL) liblwgeom.a $(DESTDIR)$(libdir)/liblwgeom.a
	@echo "Remember to run ldconfig"

uninstall-liblwgeom: 
	rm -f $(DESTDIR)$(libdir)/liblwgeom.so.$(SOVER)
	rm -f $(DESTDIR)$(libdir)/liblwgeom.a

liblwgeom.a: $(SA_OBJS) $(NM_OBJS) $(SA_HEADERS)
	ar rs liblwgeom.a $(SA_OBJS) $(NM_OBJS) 

liblwgeom.so: $(OBJS) $(SA_HEADERS)
	$(CC) -shared -Wl,-soname,$(SONAME) -o $@ $(OBJS) $(LDFLAGS)

maintainer-clean: clean
	rm -f lwin_wkt_lex.c
	rm -f lwin_wkt_parse.h
	rm -f lwin_wkt_parse.c

clean: 
	$(MAKE) -C cunit clean
	rm -f $(OBJS) 
	rm -f liblwgeom.a 
	rm -f liblwgeom.so 

# Nothing specific in distclean (will be done by clean)
distclean:

check: liblwgeom.a
	make -C cunit check

# Command to build each of the .o files
$(SA_OBJS): %.o: %.c 
	$(CC) $(CFLAGS) -c -o $@ $<

# Command to build each of the .o files
$(NM_OBJS): %.o: %.c 
	$(CC) $(CFLAGS) $(NUMERICFLAGS) -c -o $@ $<

# Generate WKT parser from Flex/Yacc inputs
lwin_wkt_parse.c: lwin_wkt_parse.y
	$(YACC) -o'$@' -d $^
  
#       $(YACC) --debug --verbose -o'$@' -d $<
#       $(YACC) -o'$@' -d $^

lwin_wkt_lex.c: lwin_wkt_lex.l
	$(LEX) -i $<


# Commands to generate the lexer and parser from input files
wktparse.tab.c: wktparse.y
	$(YACC) -vd -p lwg_parse_yy wktparse.y
	mv -f y.tab.c wktparse.tab.c
	mv -f y.tab.h wktparse.tab.h
 
lex.yy.c: wktparse.lex wktparse.tab.c
	$(LEX) -Plwg_parse_yy -i -f -o'lex.yy.c' wktparse.lex
 
