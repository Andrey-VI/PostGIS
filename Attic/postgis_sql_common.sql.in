-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- SPATIAL_REF_SYS

CREATE TABLE spatial_ref_sys (
	 srid integer not null primary key,
	 auth_name varchar(256), 
	 auth_srid integer, 
	 srtext varchar(2048),
	 proj4text varchar(2048) 
);

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- GEOMETRY_COLUMNS

CREATE TABLE geometry_columns (
	f_table_catalog varchar(256) not null,
	f_table_schema varchar(256) not null,
	f_table_name varchar(256) not null,
	f_geometry_column varchar(256) not null,
	coord_dimension integer not null,
	srid integer not null,
	type varchar(30) not null,
	attrelid oid,
	varattnum int,
	stats histogram2d,
	CONSTRAINT geometry_columns_pk primary key ( 
		f_table_catalog, 
		f_table_schema, 
		f_table_name, 
		f_geometry_column ) );

--
-- Workaround for old user defined variable length datatype 
-- default value bug. Should not be necessary > 7.2
-- 

UPDATE pg_type SET typdefault = NULL WHERE typname = 'wkb';
UPDATE pg_type SET typdefault = NULL WHERE typname = 'geometry';
UPDATE pg_type SET typdefault = NULL WHERE typname = 'histogram2d';

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- POSTGIS_VERSION()

CREATE FUNCTION postgis_version() RETURNS text
AS 'SELECT \'@POSTGIS_VERSION@\'::text AS version'
LANGUAGE 'sql';

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- FIX_GEOMETRY_COLUMNS()

CREATE FUNCTION fix_geometry_columns() RETURNS text
AS 
'
BEGIN
	EXECUTE ''update geometry_columns set attrelid = (select pg_class.oid AS attrelid from pg_class,pg_attribute where relname =geometry_columns.f_table_name::name and pg_attribute.attrelid = pg_class.oid and pg_attribute.attname = geometry_columns.f_geometry_column::name), varattnum = (select pg_attribute.attnum from pg_class,pg_attribute where relname =geometry_columns.f_table_name::name and pg_attribute.attrelid = pg_class.oid and pg_attribute.attname = geometry_columns.f_geometry_column::name)'';
	RETURN ''geometry_columns table is now linked to the system tables'';
END;
'
LANGUAGE 'plpgsql' ;

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- FIND_SRID( <schema/database>, <table>, <geom col> )

CREATE FUNCTION find_srid(varchar,varchar,varchar) RETURNS int4 AS
'select SRID from geometry_columns where f_table_schema like $1 || ''%'' and f_table_name = $2 and f_geometry_column = $3' 
LANGUAGE 'sql' 
WITH (iscachable,isstrict); 

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- GET_PROJ4_FROM_SRID( <srid> )

CREATE FUNCTION get_proj4_from_srid(integer) RETURNS text AS
'SELECT proj4text::text FROM spatial_ref_sys WHERE srid= $1' 
LANGUAGE 'sql' WITH (iscachable,isstrict);

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- DROPGEOMETRYCOLUMN( <db name>, <table name>, <column name> )
--
-- There is no ALTER TABLE DROP COLUMN command in postgresql
-- There is no ALTER TABLE DROP CONSTRAINT command in postgresql
-- So, we:
--   1. remove the unwanted geom column reference from the 
--      geometry_columns table
--   2. update the table so that the geometry column is all NULLS
--      This is okay since the CHECK srid(geometry) = <srid> is not
--      checked if geometry is NULL (the isstrict attribute on srid())
--   3. add another constraint that the geometry column must be NULL
-- This, effectively kills the geometry column 
--   (a) its not in the geometry_column table
--   (b) it only has nulls in it
--   (c) you cannot add anything to the geom column because it must be NULL
-- 
-- This will screw up if you put a NOT NULL constraint on the geometry 
-- column, so the first thing we must do is remove this constraint (its a 
-- modification of the pg_attribute system table)
--
-- We also check to see if the table/column exists in the geometry_columns 
-- table 

CREATE FUNCTION DropGeometryColumn(varchar,varchar,varchar)
	RETURNS text
	AS 
'
DECLARE
	database_name alias for $1;
	table_name alias for $2;
	column_name alias for $3;
	myrec RECORD;
	okay boolean;
BEGIN
 	-- first we find out if the column is in the geometry_columns table
	okay = ''f'';
	FOR myrec IN SELECT * from geometry_columns where f_table_schema = database_name and f_table_name = table_name and f_geometry_column = column_name LOOP
		okay := ''t'';
	END LOOP; 
	IF (okay <> ''t'') THEN 
		RAISE EXCEPTION ''column not found in geometry_columns table'';
		return ''f'';
	END IF;
	
	-- ensure the geometry column does not have a NOT NULL attribute
	EXECUTE ''update pg_attribute set attnotnull = false from pg_class where pg_attribute.attrelid = pg_class.oid and pg_class.relname = '' || quote_literal(table_name) ||'' and pg_attribute.attname = '' || quote_literal(column_name);

	-- remove ref from geometry_columns table
	EXECUTE ''delete from geometry_columns where f_table_schema = '' || quote_literal(database_name) ||
		 '' and f_table_name = '' || quote_literal(table_name) || 
		 '' and f_geometry_column = '' || quote_literal(column_name );

	-- update the given table/column so that it it all NULLS

	EXECUTE ''update "''||table_name||''" set "''||column_name||''"= NULL'';

	-- add = NULL constraint to given table/column

	EXECUTE ''ALTER TABLE "''||table_name||''" ADD CHECK ("''||column_name||''" IS NULL)'';

	RETURN table_name || ''.'' || column_name ||'' effectively removed.'';
	
END;
'
	LANGUAGE 'plpgsql' WITH (isstrict);

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- ADDGEOMETRYCOLUMN( 
--      <db name>, 
--      <table name>, 
--      <column name>, 
--      <srid>, 
--      <type>, 
--      <dim> )
--
-- Type can be one of geometry, GEOMETRYCOLLECTION, POINT, MULTIPOINT, POLYGON,
-- MULTIPOLYGON, LINESTRING, or MULTILINESTRING.
--
-- Types (except geometry) are checked for consistency using a CHECK constraint
-- uses SQL ALTER TABLE command to add the geometry column to the table
-- added a row to geometry_columns WITH info (catalog = '', schema = <db name>)
-- addes a constraint on the table that all the geometries MUST have the same 
-- SRID checks the coord_dimension to make sure its between 0 and 3
-- should also check the precision grid (future expansion)
-- also checks to see if the database_name is in the pg_database table.

CREATE FUNCTION AddGeometryColumn(varchar,varchar,varchar,integer,varchar,integer)
	RETURNS text
	AS 
'
DECLARE
	database_name alias for $1;
	table_name alias for $2;
	column_name alias for $3;
	new_srid alias for $4;
	new_type alias for $5;
	new_dim alias for $6;
	
	real_db_name varchar;
	db_query record;
	db_name_ok boolean;

BEGIN

	IF (not( (new_type =''GEOMETRY'') or (new_type =''GEOMETRYCOLLECTION'') or (new_type =''POINT'')
		 or (new_type =''MULTIPOINT'') or 	(new_type =''POLYGON'') or (new_type =''MULTIPOLYGON'') 
		 or (new_type =''LINESTRING'') or (new_type =''MULTILINESTRING'')) ) THEN		
		RAISE EXCEPTION ''Invalid type name - valid ones are: GEOMETRY, GEOMETRYCOLLECTION,POINT,MULTIPOINT,POLYGON,MULTIPOLYGON,LINESTRING, or MULTILINESTRING '';
		return ''fail'';
	END IF;

	IF ( (new_dim >3) or (new_dim <0) ) THEN
		RAISE EXCEPTION ''invalid dimension'';
		return ''fail'';
	END IF;

	db_name_ok := ''f'';

	FOR db_query IN SELECT datname from pg_database where text(datname) = database_name LOOP
		db_name_ok := ''t'';
	END LOOP; 

	IF (db_name_ok <> ''t'') THEN
		RAISE EXCEPTION ''Invalid database name.'';
		return ''fail'';
	END IF;

	EXECUTE ''ALTER TABLE "'' || table_name || ''" ADD COLUMN "'' || column_name || ''" geometry '';
	EXECUTE ''INSERT INTO 	geometry_columns VALUES ('' || quote_literal('''') || '','' ||
			 quote_literal(database_name) || '','' || quote_literal(table_name) || '','' ||
			 quote_literal(column_name) || '','' ||
			 new_dim ||'',''||new_srid||'',''||quote_literal(new_type)||'')'';

	EXECUTE ''update geometry_columns set attrelid = (select pg_class.oid AS attrelid from pg_class,pg_attribute where relname =geometry_columns.f_table_name::name and pg_attribute.attrelid = pg_class.oid and pg_attribute.attname = geometry_columns.f_geometry_column::name), varattnum = (select pg_attribute.attnum from pg_class,pg_attribute where relname =geometry_columns.f_table_name::name and pg_attribute.attrelid = pg_class.oid and pg_attribute.attname = geometry_columns.f_geometry_column::name)'';

 
	EXECUTE ''ALTER TABLE "'' ||table_name||''" ADD CHECK (SRID("'' || column_name ||
		''") = '' || new_srid || '')'' ;

	IF (not(new_type = ''GEOMETRY'')) THEN
		EXECUTE ''ALTER TABLE "'' ||table_name||''" ADD CHECK ( geometrytype("''||column_name||''")=''|| quote_literal(new_type)||'' OR ('' ||column_name ||'') is null)'';
	END IF;

	return ''Geometry column '' || column_name || '' added to table ''
			||table_name ||'' WITH a SRID of ''||new_srid || '' and type ''||new_type;	
END;
'
	LANGUAGE 'plpgsql' WITH (isstrict);

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- FIND_EXTENT( <table name>, <column name> )

CREATE FUNCTION find_extent(text,text) RETURNS box3d AS
'
DECLARE
	tablename alias for $1;
	columnname alias for $2;
	okay boolean;
 myrec RECORD;

BEGIN
	FOR myrec IN EXECUTE ''SELECT extent("''||columnname||''") FROM "''||tablename||''"'' LOOP
		return myrec.extent;
	END LOOP; 
END;
'
LANGUAGE 'plpgsql' WITH (isstrict);

-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- TRANSFORM ( <geometry>, <srid> )
--
-- Test:
--
-- trans=# select * from spatial_ref_sys ;
--
--  srid |   auth_name   | auth_srid | srtext | proj4text 
-- ------+---------------+-----------+--------+--------------------------------------------------------------------------
--     1 | latlong WGS84 |         1 |        | +proj=longlat +datum=WGS84
--     2 | BC albers     |         2 |        | proj=aea ellps=GRS80 lon_0=-126 lat_0=45 lat_1=50 lat_2=58.5 x_0=1000000
--
-- select transform( 'SRID=1;POINT(-120.8 50.3)', 2);
--      -> 'SRID=2;POINT(1370033.37046971 600755.810968684)'
--

CREATE FUNCTION transform_geometry(geometry,text,text,int)
	RETURNS geometry
	AS '@MODULE_FILENAME@','transform_geom'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION transform(geometry,integer) RETURNS geometry AS
'BEGIN
 RETURN transform_geometry( $1 , get_proj4_from_srid(SRID( $1 ) ), get_proj4_from_srid( $2 ), $2 );
 END;'
LANGUAGE 'plpgsql' WITH (iscachable,isstrict);



-- - - - - - - - - - - - - - - - - - - - - - - - - - - -
-- COMMON FUNCTIONS

CREATE FUNCTION srid(chip)
	RETURNS int4
	AS '@MODULE_FILENAME@','srid_chip'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION height(chip)
	RETURNS int4
	AS '@MODULE_FILENAME@','height_chip'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION factor(chip)
	RETURNS FLOAT4
	AS '@MODULE_FILENAME@','factor_chip'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION width(chip)
	RETURNS int4
	AS '@MODULE_FILENAME@','width_chip'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION datatype(chip)
	RETURNS int4
	AS '@MODULE_FILENAME@','datatype_chip'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION compression(chip)
	RETURNS int4
	AS '@MODULE_FILENAME@','compression_chip'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION setSRID(chip,int4)
	RETURNS chip
	AS '@MODULE_FILENAME@','setsrid_chip'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION setfactor(chip,float4)
	RETURNS chip
	AS '@MODULE_FILENAME@','setfactor_chip'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION geometry(CHIP)
	RETURNS geometry
	AS '@MODULE_FILENAME@','CHIP_to_geom'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION box3d(geometry)
	RETURNS box3d
	AS '@MODULE_FILENAME@','get_bbox_of_geometry'
	LANGUAGE 'C' WITH (iscachable,isstrict);

CREATE FUNCTION box(geometry)
	RETURNS BOX
	AS '@MODULE_FILENAME@','geometry2box'
	LANGUAGE 'C' WITH (iscachable,isstrict);

CREATE FUNCTION geometry(box3d)
	RETURNS geometry
	AS '@MODULE_FILENAME@','get_geometry_of_bbox'
	LANGUAGE 'C' WITH (iscachable,isstrict);

CREATE FUNCTION geometry(text)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_text'
	LANGUAGE 'C' WITH (iscachable,isstrict);

CREATE FUNCTION expand(box3d,float8)
	RETURNS box3d
	AS '@MODULE_FILENAME@','expand_bbox'
	LANGUAGE 'C' WITH (iscachable,isstrict);

--
-- Functions for converting to WKB
--

CREATE FUNCTION asbinary(geometry)
	RETURNS wkb
	AS '@MODULE_FILENAME@','asbinary_simple'
	LANGUAGE 'C' WITH (iscachable,isstrict);

CREATE FUNCTION asbinary(geometry,TEXT)
	RETURNS wkb
	AS '@MODULE_FILENAME@','asbinary_specify'
	LANGUAGE 'C' WITH (iscachable,isstrict);

CREATE FUNCTION bytea(wkb)
	RETURNS bytea
	AS '@MODULE_FILENAME@','WKBtoBYTEA'
	LANGUAGE 'C' WITH (iscachable,isstrict);

-- CREATE FUNCTION index_thing(geometry)
-- RETURNS BOOL
-- AS '@MODULE_FILENAME@'
-- LANGUAGE 'C' WITH (isstrict);

--
-- Debugging functions
--

CREATE FUNCTION npoints(geometry)
	RETURNS int4
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION nrings(geometry)
	RETURNS int4
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict) ;

CREATE FUNCTION mem_size(geometry)
	RETURNS int4
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION numb_sub_objs(geometry)
	RETURNS int4
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION summary(geometry)
	RETURNS text
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION translate(geometry,float8,float8,float8)
	RETURNS geometry
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict) ;

CREATE FUNCTION dimension(geometry)
	RETURNS int4
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict) ;

CREATE FUNCTION geometrytype(geometry)
	RETURNS text
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION envelope(geometry)
	RETURNS geometry
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION x(geometry)
	RETURNS float8
	AS '@MODULE_FILENAME@','x_point'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION y(geometry)
	RETURNS float8
	AS '@MODULE_FILENAME@','y_point'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION z(geometry)
	RETURNS float8
	AS '@MODULE_FILENAME@','z_point'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION numpoints(geometry)
	RETURNS integer
	AS '@MODULE_FILENAME@','numpoints_linestring'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION pointn(geometry,integer)
	RETURNS geometry
	AS '@MODULE_FILENAME@','pointn_linestring'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION exteriorring(geometry)
	RETURNS geometry
	AS '@MODULE_FILENAME@','exteriorring_polygon'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION numinteriorrings(geometry)
	RETURNS integer
	AS '@MODULE_FILENAME@','numinteriorrings_polygon'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION interiorringn(geometry,integer)
	RETURNS geometry
	AS '@MODULE_FILENAME@','interiorringn_polygon'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION numgeometries(geometry)
	RETURNS integer
	AS '@MODULE_FILENAME@','numgeometries_collection'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometryn(geometry,integer)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometryn_collection'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION max_distance(geometry,geometry)
	RETURNS float8
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION optimistic_overlap(geometry,geometry,FLOAT8)
	RETURNS BOOL
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION segmentize(geometry,FLOAT8)
	RETURNS geometry
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION distance(geometry,geometry)
	RETURNS float8
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION astext(geometry)
	RETURNS TEXT
	AS '@MODULE_FILENAME@','astext_geometry'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION srid(geometry)
	RETURNS int4
	AS '@MODULE_FILENAME@','srid_geom'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometryfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION geomfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION polygonfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION multipolygonfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION linestringfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION multilinestringfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION pointfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION multipointfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION geometrycollectionfromtext(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION setSRID(geometry,int4)
	RETURNS geometry
	AS '@MODULE_FILENAME@','geometry_from_text'
	LANGUAGE 'C' WITH (isstrict,iscachable);

--
-- Special spheroid functions
--

CREATE FUNCTION length_spheroid(geometry,spheroid)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','length_ellipsoid'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION length3d_spheroid(geometry,spheroid)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','length3d_ellipsoid'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION distance_spheroid(geometry,geometry,spheroid)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','distance_ellipsoid'
	LANGUAGE 'C' WITH (isstrict);

--
-- Generic operations
--

CREATE FUNCTION length3d(geometry)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION length(geometry)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','length2d'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION area2d(geometry)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION perimeter3d(geometry)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION perimeter(geometry)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','perimeter2d'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION truly_inside(geometry,geometry)
	RETURNS bool
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION point_inside_circle(geometry,float8,float8,float8)
	RETURNS bool
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION startpoint(geometry)
	RETURNS geometry
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION endpoint(geometry)
	RETURNS geometry
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION isclosed(geometry)
	RETURNS boolean
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION centroid(geometry)
	RETURNS geometry
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C' WITH (isstrict);

--
-- BBox operations
--

CREATE FUNCTION xmin(box3d)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','box3d_xmin'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION ymin(box3d)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','box3d_ymin'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION zmin(box3d)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','box3d_zmin'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION xmax(box3d)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','box3d_xmax'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION ymax(box3d)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','box3d_ymax'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION zmax(box3d)
	RETURNS FLOAT8
	AS '@MODULE_FILENAME@','box3d_zmax'
	LANGUAGE 'C' WITH (isstrict,iscachable);

CREATE FUNCTION box3dtobox(box3d)
	RETURNS BOX
	AS '@MODULE_FILENAME@','box3dtobox'
	LANGUAGE 'C' WITH (isstrict,iscachable);

--
-- Aggregate functions
--

CREATE FUNCTION combine_bbox(box3d,geometry)
	RETURNS box3d
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C';

CREATE AGGREGATE extent(
	sfunc = combine_bbox,
	basetype = geometry,
	stype = box3d
	);

CREATE FUNCTION collector(geometry,geometry)
	RETURNS geometry
	AS '@MODULE_FILENAME@'
	LANGUAGE 'C';

CREATE AGGREGATE collect(
	sfunc = collector,
	basetype = geometry,
	stype = geometry
	);

--
-- Operator definitions
--

CREATE FUNCTION geometry_overleft(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_overright(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_left(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_right(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_contain(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_contained(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_overlap(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_same(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

--
-- Sorting functions
--

CREATE FUNCTION geometry_lt(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_gt(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION geometry_eq(geometry, geometry) 
	RETURNS bool
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

--
-- Two dimensional to three dimensional forces
-- 

CREATE FUNCTION force_2d(geometry) 
	RETURNS geometry
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION force_3d(geometry) 
	RETURNS geometry
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

--
-- Force collection
--

CREATE FUNCTION force_collection(geometry) 
	RETURNS geometry
	AS '@MODULE_FILENAME@' 
	LANGUAGE 'C' WITH (isstrict);

-- 
-- Operator definitions
--

CREATE OPERATOR << (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_left,
   COMMUTATOR = '>>',
   RESTRICT = positionsel, JOIN = positionjoinsel
);

CREATE OPERATOR &< (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_overleft,
   COMMUTATOR = '&>',
   RESTRICT = positionsel, JOIN = positionjoinsel
);

CREATE OPERATOR && (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_overlap,
   COMMUTATOR = '&&',
   RESTRICT = postgis_gist_sel, JOIN = positionjoinsel
);

CREATE OPERATOR &> (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_overright,
   COMMUTATOR = '&<',
   RESTRICT = positionsel, JOIN = positionjoinsel
);

CREATE OPERATOR >> (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_right,
   COMMUTATOR = '<<',
   RESTRICT = positionsel, JOIN = positionjoinsel
);

CREATE OPERATOR ~= (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_same,
   COMMUTATOR = '=', 
   RESTRICT = eqsel, JOIN = eqjoinsel
);

CREATE OPERATOR @ (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_contained,
   COMMUTATOR = '@',
   RESTRICT = contsel, JOIN = contjoinsel
);

CREATE OPERATOR ~ (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_contain,
   COMMUTATOR = '@',
   RESTRICT = contsel, JOIN = contjoinsel
);

CREATE OPERATOR = (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_eq,
   COMMUTATOR = '=',
   RESTRICT = contsel, JOIN = contjoinsel
);

CREATE OPERATOR < (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_lt,
   COMMUTATOR = '<',
   RESTRICT = contsel, JOIN = contjoinsel
);

CREATE OPERATOR > (
   LEFTARG = GEOMETRY, RIGHTARG = GEOMETRY, PROCEDURE = geometry_gt,
   COMMUTATOR = '>',
   RESTRICT = contsel, JOIN = contjoinsel
);

--
-- GEOS Functions
--

CREATE FUNCTION relate(geometry,geometry)
   RETURNS text
   AS '@MODULE_FILENAME@','relate_full'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION relate(geometry,geometry,text)
   RETURNS boolean
   AS '@MODULE_FILENAME@','relate_pattern'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION disjoint(geometry,geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION touches(geometry,geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION intersects(geometry,geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION crosses(geometry,geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION within(geometry,geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION contains(geometry,geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION overlaps(geometry,geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);

CREATE FUNCTION isvalid(geometry)
   RETURNS boolean
   AS '@MODULE_FILENAME@'
   LANGUAGE 'C' WITH (isstrict);
   
